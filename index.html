<DOCTYPE html>
<html>
<head>
<style>
  .hidden {
    display: none;
  }
  canvas {
    display: none;
  }
</style>
<script src="bower_components/gif.js/dist/gif.js"></script>
<meta charset="utf-8">
<title>Christmas Hugs - Hug Humanity</title>
<!--
https://github.com/hdragomir/gif.js
-->
<body>

<h1>Christmas Hugs</h1>
<button>Make a hug</button>
<p>Show your love for the world in 3 seconds</p>

<video width='640' height='480'></video>
<canvas width='160' height='120'></canvas>
<img class='hidden' src="">
<img id='target' src="">

<script>


  /*
  Generate GIF
  var gif = new GIF({ workers: 2, quality: 10, width: 640, height: 480 });
  gif.addFrame(ctx, {copy: true});
  gif.render();
  */


  navigator.getUserMedia  = navigator.getUserMedia ||
                          navigator.webkitGetUserMedia ||
                          navigator.mozGetUserMedia ||
                          navigator.msGetUserMedia;

  var constraints = { audio: false, video: true };
  var video = document.querySelector('video');
  var canvas = document.querySelector('canvas');
  var button = document.querySelector('button');
  var target = document.getElementById('target');
  var ctx = canvas.getContext('2d');
  var localMediaStream = null;


  button.addEventListener('click', snapshot, false);
  button.addEventListener('click', makeHug, false);


  function successCallback(stream) {
    if (window.URL) {
      video.src = window.URL.createObjectURL(stream);
      localMediaStream = stream;
    } else {
      video.src = stream;
    }
    video.play();
  }

  function pipeVideoToImage () {
    setInterval(snapshot, 1000);
  }

  function errorCallback(error) {
    console.log("navigator.getUserMedia error: ", error);
  }

  function makeHug () {

    var gif = new GIF({
      workers: 2,
      quality: 1,
      width: 160,
      height: 120, 
      workerScript: 'bower_components/gif.js/dist/gif.worker.js'
    });

    gif.on('finished', function(blob) {
      target.src = window.URL.createObjectURL(blob);
    });

    var takePictures = setInterval (function () { 
      gif.addFrame(ctx, {copy: true, delay: 100});
    }, 100 );

    setTimeout(function() { 
      clearTimeout(takePictures); 
      gif.render(); 
    }, 2000);

  }

  function snapshot() {
    setInterval( function () {
      if (localMediaStream) {
        ctx.drawImage(video, 0, 0, 160, 120);
        // "image/webp" works in Chrome.
        // Other browsers will fall back to image/png.
        document.querySelector('img').src = canvas.toDataURL('image/webp');
      }
    }, 100);
  }

  navigator.getUserMedia(constraints, successCallback, errorCallback);

</script>
</body>
</html>

